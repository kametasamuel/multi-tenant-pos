// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Business Type Enum
enum BusinessType {
  RETAIL
  RESTAURANT
  SALON
  PHARMACY
  GROCERY
  ELECTRONICS
  CLOTHING
  OTHER
}

// Subscription Tier: Plans that control feature access
model SubscriptionTier {
  id                String   @id @default(uuid())
  name              String   @unique // e.g., "Basic", "Professional", "Enterprise"
  description       String?
  monthlyPrice      Float    @default(0)
  annualPrice       Float    @default(0)
  maxUsers          Int      @default(5)
  maxBranches       Int      @default(1)
  maxProducts       Int      @default(100)
  isActive          Boolean  @default(true)
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenants           Tenant[]
  features          TierFeature[]

  @@map("subscription_tiers")
}

// Feature definitions for tier-based access control
model Feature {
  id                String   @id @default(uuid())
  code              String   @unique // e.g., "analytics", "smart_fifo", "multi_branch", "api_access"
  name              String           // Human-readable name
  description       String?
  category          String   @default("general") // e.g., "analytics", "inventory", "integrations"
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tierFeatures      TierFeature[]

  @@map("features")
}

// Many-to-many: Features enabled for each tier
model TierFeature {
  id                String   @id @default(uuid())
  tierId            String
  featureId         String
  isEnabled         Boolean  @default(true)
  createdAt         DateTime @default(now())

  tier              SubscriptionTier @relation(fields: [tierId], references: [id], onDelete: Cascade)
  feature           Feature          @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([tierId, featureId])
  @@map("tier_features")
}

// Global Tax Configuration pushed to tenants
model TaxConfig {
  id                String   @id @default(uuid())
  country           String           // Country code (GH, NG, KE, US, etc.)
  name              String           // e.g., "VAT", "E-Levy", "NHIL"
  rate              Float            // Tax rate as decimal
  isCompound        Boolean  @default(false) // Applied on top of other taxes
  isActive          Boolean  @default(true)
  effectiveFrom     DateTime @default(now())
  effectiveTo       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([country, isActive])
  @@map("tax_configs")
}

// Admin Impersonation Log: Audit trail for "login as tenant" actions
model ImpersonationLog {
  id                String   @id @default(uuid())
  adminId           String           // Super admin who impersonated
  tenantId          String           // Tenant that was accessed
  reason            String           // Why impersonation was needed
  startedAt         DateTime @default(now())
  endedAt           DateTime?
  ipAddress         String?
  userAgent         String?
  actionsPerformed  String?  @db.Text // JSON array of actions taken

  @@index([adminId, startedAt])
  @@index([tenantId, startedAt])
  @@map("impersonation_logs")
}

// Multi-Tenant: Each business has a unique ID
model Tenant {
  id                String       @id @default(uuid())
  businessName      String       @unique
  slug              String?      @unique // URL slug for tenant (e.g., "trim" for smartpos.com/trim)
  businessType      BusinessType @default(RETAIL)
  businessLogo      String?
  country           String       @default("GH") // Country code for tax/locale
  currency          String       @default("USD") // Currency code (USD, GHS, NGN, KES, etc.)
  currencySymbol    String       @default("$")   // Currency symbol ($, GH₵, ₦, KSh, etc.)
  taxRate           Float        @default(0)     // Tax rate as decimal (e.g., 0.08 for 8%)
  tierId            String?      // Subscription tier
  subscriptionStart DateTime     @default(now())
  subscriptionEnd   DateTime
  gracePeriodEnd    DateTime?    // Extended access period after subscription expires
  isActive          Boolean      @default(true)
  isInGracePeriod   Boolean      @default(false) // True when subscription expired but in grace
  lastActivityAt    DateTime?    // Last transaction or login time (for health tracking)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  tier              SubscriptionTier? @relation(fields: [tierId], references: [id])
  users             User[]
  products          Product[]
  sales             Sale[]
  expenses          Expense[]
  customers         Customer[]
  auditLogs         AuditLog[]
  securityRequests  SecurityRequest[]
  branches          Branch[]
  branchRequests    BranchRequest[]

  @@index([tierId])
  @@index([country])
  @@index([isActive])                    // Filter active tenants
  @@index([businessType])                // Filter by business type
  @@index([subscriptionEnd])             // Find expiring subscriptions
  @@index([isActive, subscriptionEnd])   // Combined for subscription queries
  @@map("tenants")
}

// Users: Staff (Cashier) and Admin
model User {
  id           String   @id @default(uuid())
  username     String
  password     String   // Hashed password
  fullName     String
  email        String?  // Personal email (editable by owner)
  phone        String?  // Personal phone (editable by owner)
  profileImage String?  // URL path to profile image
  role         Role     @default(CASHIER)
  isActive     Boolean  @default(true)
  isSuperAdmin Boolean  @default(false)
  tenantId     String
  branchId     String?  // Optional branch assignment
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant                  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch                  Branch?           @relation(fields: [branchId], references: [id])
  sales                   Sale[]            @relation("CashierSales")
  voidedSales             Sale[]            @relation("VoidedSales")
  expenses                Expense[]
  auditLogs               AuditLog[]
  requestsMade            SecurityRequest[] @relation("RequestsMade")
  requestsReviewed        SecurityRequest[] @relation("RequestsReviewed")
  branchRequestsMade      BranchRequest[]   @relation("BranchRequestsMade")
  branchRequestsReviewed  BranchRequest[]   @relation("BranchRequestsReviewed")

  @@unique([username, tenantId]) // Username unique per tenant
  @@index([branchId])
  @@index([tenantId])              // Critical for tenant user lookups
  @@index([tenantId, role])        // Filter users by role within tenant
  @@index([tenantId, isActive])    // Active users per tenant
  @@map("users")
}

enum Role {
  CASHIER
  MANAGER
  OWNER
  ADMIN  // Kept for backward compatibility, same as OWNER
}

// Products: Inventory items and services
model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    ProductCategory @default(PRODUCT)
  customCategory String?       // Custom category tag (e.g., "Hair Products", "Drinks")
  barcode     String?
  costPrice   Float    @default(0)
  sellingPrice Float
  stockQuantity Int    @default(0)
  lowStockThreshold Int @default(10)
  expiryDate  DateTime?        // Product expiry date (optional)
  isActive    Boolean  @default(true)
  tenantId    String
  branchId    String?          // Branch that owns this product
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch?  @relation(fields: [branchId], references: [id])
  saleItems   SaleItem[]

  @@index([tenantId, name])
  @@index([branchId])
  @@index([tenantId, isActive])      // Active products per tenant
  @@index([tenantId, category])      // Filter by category
  @@index([barcode])                 // Quick barcode lookups (POS scanning)
  @@map("products")
}

enum ProductCategory {
  PRODUCT
  SERVICE
}

// Customers: Customer records for loyalty and tracking
model Customer {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  email       String?
  address     String?
  notes       String?
  totalSpent  Float    @default(0)
  visitCount  Int      @default(0)
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sales       Sale[]

  @@index([tenantId, name])
  @@index([tenantId, phone])
  @@map("customers")
}

// Sales: Transaction records
model Sale {
  id          String   @id @default(uuid())
  transactionNumber String
  totalAmount Float
  discountAmount Float @default(0)
  finalAmount Float
  paymentMethod PaymentMethod
  paymentStatus String @default("completed") // completed, cancelled, voided
  cashierId   String
  customerId  String?
  tenantId    String
  branchId    String?  // Optional branch assignment
  // Void tracking fields
  voidedById  String?  // User who voided the sale
  voidedAt    DateTime? // When the sale was voided
  voidReason  String?  // Reason for voiding
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cashier           User              @relation("CashierSales", fields: [cashierId], references: [id])
  voidedBy          User?             @relation("VoidedSales", fields: [voidedById], references: [id])
  customer          Customer?         @relation(fields: [customerId], references: [id])
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch            Branch?           @relation(fields: [branchId], references: [id])
  items             SaleItem[]
  securityRequests  SecurityRequest[]

  @@index([tenantId, createdAt])
  @@index([cashierId, createdAt])
  @@index([branchId])
  @@index([paymentStatus])                     // Filter by payment status
  @@index([tenantId, paymentStatus])           // Voided sales per tenant
  @@index([createdAt])                         // Date range queries (super admin)
  @@index([tenantId, paymentMethod, createdAt]) // Payment method analytics
  @@index([voidedById])                        // Lookup sales voided by user
  @@map("sales")
}

model SaleItem {
  id          String   @id @default(uuid())
  saleId      String
  productId   String
  quantity    Int
  unitPrice   Float
  discount    Float    @default(0)
  subtotal    Float
  createdAt   DateTime @default(now())
  
  sale        Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([saleId])        // Faster sale item lookups
  @@index([productId])     // Product sales analysis
  @@map("sale_items")
}

enum PaymentMethod {
  CASH
  CARD
  MOMO
  BANK_TRANSFER
}

// Expenses: Business expenses
model Expense {
  id          String   @id @default(uuid())
  description String
  amount      Float
  category    String   // e.g., "Rent", "Electricity", "Internet", "Petty Cash"
  recordedBy  String   // User ID who recorded it
  tenantId    String
  branchId    String?  // Branch where expense was recorded
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recorder    User     @relation(fields: [recordedBy], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch?  @relation(fields: [branchId], references: [id])

  @@index([tenantId, createdAt])
  @@index([branchId])
  @@map("expenses")
}

// Audit Log: Track sensitive actions
model AuditLog {
  id          String   @id @default(uuid())
  action      String   // e.g., "drawer_opened", "transaction_voided", "price_changed"
  description String?
  userId      String
  tenantId    String
  branchId    String?  // Branch where action occurred
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch?  @relation(fields: [branchId], references: [id])

  @@index([tenantId, createdAt])
  @@index([branchId])
  @@map("audit_logs")
}

// Security Request Type enum
enum SecurityRequestType {
  VOID
  REVIEW
}

// Security Request Status enum
enum SecurityRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Security Requests: Void and review requests from cashiers to managers
model SecurityRequest {
  id            String                @id @default(uuid())
  type          SecurityRequestType
  status        SecurityRequestStatus @default(PENDING)
  reason        String                // Reason provided by requester
  saleId        String?               // Related sale (for void requests)
  itemName      String                // Item or transaction description
  amount        Float                 @default(0)
  requesterId   String                // User who made the request
  reviewerId    String?               // Manager who reviewed the request
  reviewedAt    DateTime?
  tenantId      String
  branchId      String?               // Branch where request was made
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  requester     User                  @relation("RequestsMade", fields: [requesterId], references: [id])
  reviewer      User?                 @relation("RequestsReviewed", fields: [reviewerId], references: [id])
  tenant        Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sale          Sale?                 @relation(fields: [saleId], references: [id])
  branch        Branch?               @relation(fields: [branchId], references: [id])

  @@index([tenantId, status])
  @@index([requesterId])
  @@index([branchId])
  @@map("security_requests")
}

// Branch: Physical business locations
model Branch {
  id          String   @id @default(uuid())
  name        String
  address     String?
  phone       String?
  isActive    Boolean  @default(true)
  isMain      Boolean  @default(false)
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users             User[]
  sales             Sale[]
  products          Product[]
  expenses          Expense[]
  auditLogs         AuditLog[]
  securityRequests  SecurityRequest[]

  @@index([tenantId])
  @@map("branches")
}

// Branch Request Status enum
enum BranchRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Branch Requests: Owner requests for new branches, reviewed by super admin
model BranchRequest {
  id              String              @id @default(uuid())
  branchName      String
  address         String?
  phone           String?
  reason          String
  status          BranchRequestStatus @default(PENDING)
  requesterId     String
  reviewerId      String?
  reviewedAt      DateTime?
  rejectionReason String?
  tenantId        String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  requester       User     @relation("BranchRequestsMade", fields: [requesterId], references: [id])
  reviewer        User?    @relation("BranchRequestsReviewed", fields: [reviewerId], references: [id])
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@map("branch_requests")
}

// Application Status enum
enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Tenant Applications: New business signups awaiting approval
model TenantApplication {
  id                String            @id @default(uuid())
  businessName      String
  businessType      BusinessType      @default(RETAIL)
  businessEmail     String            @unique
  businessPhone     String?
  businessLogo      String?
  businessAddress   String?

  // Admin user details (becomes tenant admin on approval)
  ownerFullName     String
  ownerEmail        String
  ownerPhone        String?
  password          String            // Hashed - used when creating admin user

  // Status tracking
  status            ApplicationStatus @default(PENDING)
  slug              String?           // URL slug assigned by super admin on approval
  rejectionReason   String?
  reviewedBy        String?
  reviewedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status, createdAt])
  @@map("tenant_applications")
}
